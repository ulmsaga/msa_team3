name: CI/CD Pipeline

jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Get version
        id: get_version
        run: |
          cd services/configserver
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Update Helm values
        env:
          GH_TOKEN: ${{ secrets.GH_FOR_HELM_IN_WORKFLOW }}
        run: |
          cd helmcharts/configserver
          argocd login localhost:30309 \
            --username admin \
            --password 'akfxlwm40__-' \
            --insecure
          argocd app sync configserver --force